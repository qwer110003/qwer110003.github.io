<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8">
        <title>자리어때</title>
        <link href="./style.css" rel="stylesheet">
    </head>
    <body style="padding: 0; margin: 0;">
        <header style="display: flex; background-color: #ffffff; position: fixed; width: 100%; top: 0;">
            <nav class="nav-style">
                <div class="nav-logo">
                    <a href="./index.html">
                        <img src="./자리어때.svg" class="logo-img">
                    </a>
                </div>
                <div style="display: flex; justify-content: end; align-items: center; width: 100%;">
                    <div class="top-bar">
                        <div class="search-box">
                            <input type="text" id="searchInput" placeholder="가게 검색">
                            <button class="search-btn" onclick="toggleSearch()">
                                <img src="./fi-rs-search.svg" class="search-icn">
                            </button>
                        </div>
                        <button class="notification-btn" onclick="toggleNotificationPanel()">
                            <img src="./fi-rs-bell.svg" class="notification-icn">
                        </button>
                    </div>
                </div>
            </nav>
            <div class="notification-panel" id="notificationPanel">
        </div>
        </header>
        <div>
            <div style="margin-top: 8.5vh"></div>
            <div class="info-box">
                <div class="store-list" id="storeListBig"></div>
            </div>
        </div>





















        <script>
            const stores = [
                { 
                    name: "삼춘네", 
                    address: "충남 천안시 동남구 문암로 69", 
                    latitude: 36.8152, 
                    longitude: 127.1543, 
                    level: "혼잡", 
                    addrUrl: `kakaomap://search?q=${encodeURIComponent("삼춘네")}` ,
                    imageUrl: "./samc.jpg"
                },
                { 
                    name: "면식당", 
                    address: "충남 천안시 동남구 문암로 66", 
                    latitude: 36.8155, 
                    longitude: 127.1546, 
                    level: "보통", 
                    addrUrl: `kakaomap://search?q=${encodeURIComponent("면식당")}` ,
                    imageUrl: "./austlrekd.jpg"
                },
                { 
                    name: "천원국수", 
                    address: "충남 천안시 동남구 문암로 66", 
                    latitude: 36.8153, 
                    longitude: 127.1545, 
                    level: "여유", 
                    addrUrl: `kakaomap://search?q=${encodeURIComponent("천원국수")}` 
                },
                { 
                    name: "야간작업", 
                    address: "충남 천안시 동남구 문암로 77", 
                    latitude: 36.8158, 
                    longitude: 127.1550, 
                    level: "혼잡", 
                    addrUrl: `kakaomap://search?q=${encodeURIComponent("야간작업")}` 
                },
                { 
                    name: "고기굽는집", 
                    address: "충남 천안시 동남구 문암로 79", 
                    latitude: 36.8160, 
                    longitude: 127.1553, 
                    level: "혼잡", 
                    addrUrl: `kakaomap://search?q=${encodeURIComponent("고기굽는집")}` ,
                    imageUrl: "./gogoob.jpg"
                }
            ];

            function storeListBig(stores){
                const container = document.getElementById("storeListBig");
                if (!container) return;
                container.innerHTML = "";

                stores.forEach(store => {
                    // 영업 상태 판단
                    const isOpenNow = store.storeHours ? store.storeHours.some(hour => hour.isOpen) : false;
                    const statusText = isOpenNow ? "영업 중" : "영업 종료";
                    const statusColor = isOpenNow ? "green" : "red";

                    // 혼잡도 상태
                    let crowdText = "";
                    let crowdColor = "";
                    let levelMsg = "";

                    switch(store.level) {
                        case "여유":
                            crowdText = store.level;
                            crowdColor = "green";
                            levelMsg = "빈 자리 다수";
                            break;
                        case "보통":
                            crowdText = store.level;
                            crowdColor = "orange";
                            levelMsg = "빈 자리 약간";
                            break;
                        default:
                            crowdText = store.level || "정보 없음";
                            crowdColor = "red";
                            levelMsg = "빈 자리 없음";
                    }

                    // 영업시간 텍스트 생성
                    let hoursText = "";
                    if (store.storeHours && store.storeHours.length > 0) {
                        hoursText = store.storeHours.map(hour => {
                            const openClose = hour.isOpen ? `${hour.openTime} ~ ${hour.closeTime}` : "휴무";
                            return `${hour.dayOfWeek}: ${openClose}`;
                        }).join('<div class="border-line"></div>');
                    }

                    // 매장 카드 HTML 생성
                    const cardHtml = `
                        <div class="store-box">
                            <div class=store-header>
                                <div class="store-img">
                                    <img src="${store.imageUrl || './default.png'}" style="width: 100;">
                                </div>
                                <div class="store-title">
                                    <p class="title-txt">${store.name}</p>
                                </div>
                            </div>
                            <div class="main-img">
                                <img src="${store.imageUrl || './default.png'}" style="width: 100%;">
                            </div>
                            <div class="store-exp">
                                <div class="store-info">
                                    <div class="isOpen">
                                        <p class="isOpen-txt" style="color: ${statusColor}">${statusText}</p>
                                        <span class="opentime-txt">${hoursText}</span>
                                    </div>
                                    <div class="crowd-level">
                                        <span class="crowd-txt" style="color: ${crowdColor};">${crowdText}</span>
                                        <span class="crowd-exp">${levelMsg}</span>
                                    </div>
                                    <div class="store-addr">
                                        <div class="addr-svg">
                                            <a href="${store.addrUrl}">
                                            <svg width="clamp(20px, 6.5vw, 80px)" height="clamp(20px, 6.5vw, 80px)" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <g clip-path="url(#clip0_52_61)">
                                                <path d="M12 11.9999C12.7911 11.9999 13.5645 11.7653 14.2223 11.3257C14.8801 10.8862 15.3928 10.2615 15.6955 9.53059C15.9983 8.79969 16.0775 7.99542 15.9231 7.2195C15.7688 6.44357 15.3878 5.73084 14.8284 5.17143C14.269 4.61202 13.5563 4.23106 12.7804 4.07672C12.0044 3.92238 11.2002 4.00159 10.4693 4.30434C9.73836 4.60709 9.11365 5.11978 8.67412 5.77758C8.2346 6.43538 8 7.20873 8 7.99986C8 9.06073 8.42143 10.0781 9.17157 10.8283C9.92172 11.5784 10.9391 11.9999 12 11.9999ZM12 5.99986C12.3956 5.99986 12.7822 6.11716 13.1111 6.33692C13.44 6.55668 13.6964 6.86904 13.8478 7.23449C13.9991 7.59995 14.0387 8.00208 13.9616 8.39004C13.8844 8.778 13.6939 9.13437 13.4142 9.41407C13.1345 9.69378 12.7781 9.88426 12.3902 9.96143C12.0022 10.0386 11.6001 9.999 11.2346 9.84762C10.8692 9.69625 10.5568 9.4399 10.3371 9.111C10.1173 8.7821 10 8.39542 10 7.99986C10 7.46943 10.2107 6.96072 10.5858 6.58565C10.9609 6.21057 11.4696 5.99986 12 5.99986ZM16 22.0299L24 23.9779V13.4829C23.9998 12.8387 23.7923 12.2118 23.4081 11.6947C23.024 11.1777 22.4836 10.798 21.867 10.6119L19.767 9.91186C19.9206 9.28812 19.9988 8.64822 20 8.00586C20 5.88413 19.1572 3.8493 17.6569 2.34901C16.1566 0.848714 14.1217 0.00585938 12 0.00585938C9.87827 0.00585938 7.84344 0.848714 6.34315 2.34901C4.84286 3.8493 4 5.88413 4 8.00586C4.00296 8.41179 4.03639 8.81693 4.1 9.21786C3.64587 9.03681 3.15429 8.96981 2.66827 9.02271C2.18225 9.0756 1.7166 9.24679 1.31205 9.52129C0.907496 9.7958 0.576373 10.1652 0.347646 10.5973C0.118919 11.0294 -0.000443211 11.511 1.23664e-06 11.9999V21.7519L7.983 24.0329L16 22.0299ZM7.757 3.76386C8.88425 2.65261 10.4049 2.03183 11.9878 2.03674C13.5707 2.04165 15.0875 2.67185 16.2079 3.79007C17.3282 4.90829 17.9612 6.42392 17.9691 8.00679C17.977 9.58966 17.3591 11.1115 16.25 12.2409L12 16.3999L7.757 12.2489C6.63187 11.1237 5.99978 9.59759 5.99978 8.00636C5.99978 6.41513 6.63187 4.88907 7.757 3.76386ZM2 11.9999C1.99874 11.8349 2.03891 11.6723 2.11684 11.527C2.19476 11.3816 2.30795 11.2581 2.446 11.1679C2.59041 11.0731 2.75678 11.017 2.92911 11.0051C3.10143 10.9932 3.27392 11.0258 3.43 11.0999L4.864 11.6179C5.24766 12.3776 5.74958 13.0716 6.351 13.6739L12 19.1999L17.657 13.6669C18.2133 13.1114 18.6849 12.4773 19.057 11.7849L21.274 12.5259C21.4828 12.5856 21.6665 12.7117 21.7973 12.885C21.9281 13.0584 21.9989 13.2697 21.999 13.4869V21.4359L16 19.9699L8.02 21.9699L2 20.2459V11.9999Z" fill="#F54927"/>
                                                </g>
                                                <defs>
                                                <clipPath id="clip0_52_61">
                                                <rect width="24" height="24" fill="white"/>
                                                </clipPath>
                                                </defs>
                                            </svg>
                                            </a>
                                        </div>
                                        <a href="${store.addrUrl}" class="addr-txt">${store.address}</a>
                                    </div>
                                    <div class="alert-btn">
                                        <button class="${store.alert ? "on" : "off"}" onclick="toggleAlert(this, '${store.name}')" id="alert-btn">
                                            <img src="alert-icn-off.svg" class="alert-icn">
                                            <span class="btn-txt">${store.alert ? "혼잡도 감소 알림 신청됨" : "혼잡도 감소 알림 신청하기"}</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="border-line"></div>

                    `;

                    container.innerHTML += cardHtml;
                });
            }

            storeListBig(stores);
        
            const DEFAULT_LAT = 36.841236;
            const DEFAULT_LNG = 127.181333;
        
            function getCurrentPosition(callback) {
                if (!navigator.geolocation) {
                    alert("이 브라우저에서는 위치 정보를 지원하지 않습니다.");
                    if (typeof callback === "function") callback(DEFAULT_LAT, DEFAULT_LNG);
                    return;
                }
        
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const userLat = position.coords.latitude;
                        const userLng = position.coords.longitude;
                        if (typeof callback === "function") callback(userLat, userLng);
                    },
                    (error) => {
                        console.error("위치 정보를 가져올 수 없습니다.", error);
                        alert("위치 정보 사용이 거부되었거나 오류가 발생했습니다. 기본 위치로 설정합니다.");
                        if (typeof callback === "function") callback(DEFAULT_LAT, DEFAULT_LNG);
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            }
        
            function getDistance(lat1, lng1, lat2, lng2) {
                const R = 6371e3; // 지구 반지름 (m)
                const φ1 = lat1 * Math.PI / 180;
                const φ2 = lat2 * Math.PI / 180;
                const Δφ = (lat2 - lat1) * Math.PI / 180;
                const Δλ = (lng2 - lng1) * Math.PI / 180;
        
                const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                        Math.cos(φ1) * Math.cos(φ2) *
                        Math.sin(Δλ/2) * Math.sin(Δλ/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        
                return R * c; // 단위: m
            }
        
            getCurrentPosition((userLat, userLng) => {
                stores.forEach(store => {
                    store.distance = getDistance(userLat, userLng, store.latitude, store.longitude);
                });
        
                // 계산 후 정렬 예시: 가까운 순
                const sortedByDistance = [...stores].sort((a, b) => a.distance - b.distance);
                storeListBig(sortedByDistance);
            });
        
            const notificationPanel = document.getElementById("notificationPanel");
        
            setInterval(() => {
            let updated = false; // 알림이 추가되거나 갱신되었는지 확인
            
            stores.forEach(store => {
                let existing = document.querySelector(
                    `#notificationPanel .notification-item[data-store="${store.name}"]`
                );
        
                if (store.alert && (store.level === "보통" || store.level === "여유")) {
                    if (existing) {
                        // 이미 알림이 있으면 내용 갱신
                        existing.querySelector(".store-text").innerHTML = `
                            <strong>${store.name}</strong><br>
                            <span>현재 매장 내 자리 ${store.level === "여유" ? "여유 있습니다." : "약간 있습니다."}</span>
                        `;
                    } else {
                        // 없으면 새로 추가
                        const div = document.createElement("div");
                        div.className = "notification-item";
                        div.setAttribute("data-store", store.name);
                        div.innerHTML = `
                            <div class="store-icon">
                                <img src="${store.imageUrl}" style="width: 100%">    
                            </div>
                            <div class="store-text">
                                <strong>${store.name}</strong><br>
                                <span>현재 매장 내 자리 ${store.level === "여유" ? "여유 있습니다." : "약간 있습니다."}<span>
                            </div>
                        `;
                        notificationPanel.prepend(div);
                    }
                    updated = true; // 새 알림 or 갱신 발생
                } else {
                    // 알림이 꺼져 있거나 혼잡 상태면 패널에서 제거
                    if (existing) {
                        existing.remove();
                        updated = true; // 내용이 변했으므로 패널 열림
                    }
                }
            });
        
            // 갱신이나 추가/삭제가 있으면 패널 자동으로 열기
            if (updated) {
                notificationPanel.style.display = "block";
            }
        }, 5000);
        
        // 알림창 토글
        function toggleNotificationPanel() {
            const panel = document.getElementById("notificationPanel");
            if (!panel) return;
        
            if (panel.style.display === "block") {
                panel.style.display = "none";
            } else {
                panel.style.display = "block";
            }
        }
        
        // 초기 상태 숨김
        document.addEventListener("DOMContentLoaded", () => {
            const panel = document.getElementById("notificationPanel");
            if(panel) panel.style.display = "none";
        });
        
        
        // 알림 버튼 클릭 시
        // 혼잡도 알림 버튼 토글
        function toggleAlert(btn, storeName) {
            const store = stores.find(s => s.name === storeName);
            if (!store) return;

            // 알림 상태 토글
            store.alert = !store.alert;

            // 버튼 클래스 토글
            btn.classList.toggle("on", store.alert);
            btn.classList.toggle("off", !store.alert);

            // span 텍스트만 변경
            const span = btn.querySelector(".btn-txt");
            if (span) {
                span.textContent = store.alert ? "혼잡도 감소 알림 신청됨" : "혼잡도 감소 알림 신청하기";
            }

            const img = btn.querySelector(".alert-icn");
            if (img) {
                img.src = store.alert ? "alert-icn-on.svg" : "alert-icn-off.svg";
            }

            btn.style.backgroundColor = store.alert ? "#F54927" : "#7c7c7c";
            btn.style.color = store.alert ? "#FFFFFF" : "#000000";
        }
        
            const sortState = {
            crowd: "desc",    // 혼잡도 내림차순 초기값
            distance: "asc"   // 거리 오름차순 초기값
            };
        
            function toggleSort(type){
                if(type === "crowd"){
                    sortState.crowd = sortState.crowd === "desc" ? "asc" : "desc";
                    document.getElementById("crowdArrow").src = sortState.crowd==="desc" ? "./arrow.svg" : "./arrow-up.svg";
                    
                    const order = { 혼잡: 3, 보통: 2, 여유: 1 };
                    const sorted = [...stores].sort((a, b) => 
                        sortState.crowd === "desc" ? order[b.level] - order[a.level] : order[a.level] - order[b.level]
                    );
                    storeListBig(sorted);
        
                } else if(type === "distance"){
                    sortState.distance = sortState.distance === "asc" ? "desc" : "asc";
                    document.getElementById("distanceArrow").src = sortState.distance === "asc" ? "./arrow.svg" : "./arrow-up.svg";
        
                    const sorted = [...stores].sort((a, b) => 
                        sortState.distance === "asc" ? a.distance - b.distance : b.distance - a.distance
                    );
                    storeListBig(sorted);
                }
            }
            
            // 검색창 토글
            function toggleSearch() {
                const input = document.getElementById("searchInput");
        
                if (input.style.display === "none" || input.style.display === "") {
                    input.style.display = "inline-block";
                    input.style.width = "15vw";
                    input.focus();
                } else {
                    input.style.display = "none";
                    input.style.width = "8vw";
                    input.value = ""; // 닫을 때 초기화
                    renderStores(stores); // 원래 리스트 복원
                }
            }
        
            // 검색 기능
            function searchStores() {
                const query = document.getElementById("searchInput").value.toLowerCase();
                const filtered = stores.filter(store =>
                    store.name.toLowerCase().includes(query)
                );
                renderStores(filtered);
            }

            const buttons = document.querySelectorAll(".filter-btn");
        
            buttons.forEach(btn => {
                btn.addEventListener("click", () => {
                    // 모든 버튼 active 해제
                    buttons.forEach(b => b.classList.remove("active"));
        
                    // 클릭한 버튼에 active 추가
                    btn.classList.add("active");
        
                    // 화살표 토글 (오름/내림)
                    const arrow = btn.querySelector(".arrow");
                    if (arrow.classList.contains("up")) {
                    arrow.classList.remove("up");
                    arrow.classList.add("down");
                    } else {
                    arrow.classList.remove("down");
                    arrow.classList.add("up");
                    }
                });
            });
        
        
        
            </script>
    </body>
</html>