<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>자리어때</title>
    <link href="./index.css" rel="stylesheet">
    <!-- Kakao 지도 SDK, autoload=false -->
    <script type="text/javascript" 
            src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=cf49e414e83e11174542340618560ddf&autoload=false"></script>
</head>
<body>
    <!-- 헤더 -->
    <header class="nav-style">
        <div class="nav-logo">
            <img src="./자리어때.svg" class="logo-img">
        </div>
        <div class="top-bar">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="가게 검색">
                <button class="search-btn" onclick="toggleSearch()">
                    <img src="./fi-rs-search.svg" class="search-icn">
                </button>
            </div>
            <button class="notification-btn" onclick="toggleNotificationPanel()">
                <img src="./fi-rs-bell.svg" class="notification-icn">
            </button>
        </div>
    </header>

    <!-- 지도 영역 -->
    <div id="map"></div>

    <!-- 매장 리스트 바텀시트 -->
    <div class="bottom-sheet" id="bottomSheet">
        <div class="drag-bar" id="dragBar"></div>
        <div class="filters">
            <div class="filter-btn" onclick="toggleSort('crowd')">
                <svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" style="width: clamp(20px, 6.5vw, 80px);">
                    <circle cx="12" cy="9" r="4"/>
                    <circle cx="17" cy="9" r="3"/>
                    <circle cx="7" cy="9" r="3"/>
                    <path d="M17 13C19.4478 13.0001 20.4286 15.4456 20.7969 16.916C20.9406 17.4899 20.4862 18 19.8945 18H17.5684C17.1653 16.4903 16.3855 14.778 14.8779 13.7998C15.4201 13.321 16.1137 13 17 13Z"/>
                    <path d="M7 13C7.88599 13 8.57903 13.3212 9.12109 13.7998C7.61395 14.7781 6.83465 16.4905 6.43164 18H4.10449C3.51309 17.9997 3.05944 17.4898 3.20312 16.916C3.57139 15.4456 4.55216 13 7 13Z"/>
                    <path d="M12 14C15.7087 14 16.6665 17.301 16.9139 19.0061C16.9932 19.5526 16.5523 20 16 20H8C7.44772 20 7.00684 19.5526 7.08614 19.0061C7.33351 17.301 8.29134 14 12 14Z"/>
                </svg>   

                <p class="btn-txt">혼잡도</p>
                <img src="./arrow.svg" style="width: clamp(20px, 6.5vw, 80px)" id="crowdArrow">
            </div>

            <div class="filter-btn" onclick="toggleSort('distance')">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="width: clamp(20px, 6.5vw, 80px);">
                    <path d="M12 2C15.866 2 19 5.13401 19 9C19 14.0159 13.8819 17.0342 12.3984 17.8037C12.1456 17.9349 11.8544 17.9349 11.6016 17.8037C10.1181 17.0342 5 14.0159 5 9C5 5.13401 8.13401 2 12 2ZM12 6C10.3431 6 9 7.34315 9 9C9 10.6569 10.3431 12 12 12C13.6569 12 15 10.6569 15 9C15 7.34315 13.6569 6 12 6Z" fill="currentColor"/>
                    <path d="M18.0622 16.5C18.6766 16.9561 19 17.4734 19 18C19 18.5266 18.6766 19.0439 18.0622 19.5C17.4478 19.9561 16.5641 20.3348 15.5 20.5981C14.4359 20.8614 13.2288 21 12 21C10.7712 21 9.56414 20.8614 8.5 20.5981C7.43587 20.3348 6.5522 19.9561 5.93782 19.5C5.32344 19.0439 5 18.5266 5 18C5 17.4734 5.32344 16.9561 5.93782 16.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>                                                
                <p class="btn-txt">거리순</p>
                <img src="./arrow.svg" style="width: clamp(20px, 6.5vw, 80px)" id="distanceArrow">
            </div>

        </div>

        <!-- <div class="storeList">
            <div class="storeCard">
                <div class="storeImg">
                </div>
                <div class="storeInfo">
                    <div class="storeName">
                    </div>
                    <div class="storeOpen">
                    </div>
                    <div class="storeCrowd">
                    </div>
                    <div class="storeAddr">
                    </div>
                </div>
            </div>
        </div> -->

        <div class="store-list" id="storeList">
    </div>

    <script>
// 전역 변수
let map;

// 하드코딩 매장 데이터
const stores = [
    { name: "치킨집 A", address: "서울시 강남구", latitude: 37.497946, longitude: 127.027619, level: "여유" },
    { name: "치킨집 B", address: "서울시 서초구", latitude: 37.491944, longitude: 127.025555, level: "보통" },
    { name: "치킨집 C", address: "서울시 송파구", latitude: 37.504296, longitude: 127.106598, level: "혼잡" }
];

// 지도 초기화
function initMap() {
    const mapContainer = document.getElementById('map'); 
    const mapOption = { 
        center: new kakao.maps.LatLng(37.497946, 127.027619), // 지도 중심
        level: 5 // 확대 레벨
    };

    map = new kakao.maps.Map(mapContainer, mapOption); 

    // 마커 로드
    loadStores();
}

// 매장 마커 표시
function loadStores() {
    stores.forEach(store => {
        // 혼잡도별 마커 이미지 선택
        let markerImg = "";
        if (store.level === "여유") {
            markerImg = "./여유 위치표시.svg";
        } else if (store.level === "보통") {
            markerImg = "./보통 위치표시.svg";
        } else {
            markerImg = "./혼잡 위치표시.svg";
        }

        // 마커 이미지 객체
        const imageSize = new kakao.maps.Size(48, 52);
        const markerImage = new kakao.maps.MarkerImage(markerImg, imageSize);

        // 좌표
        const markerPosition = new kakao.maps.LatLng(store.latitude, store.longitude);

        // 마커 생성
        const marker = new kakao.maps.Marker({
            position: markerPosition,
            image: markerImage,
            map: map
        });

        // 인포윈도우
        const info = new kakao.maps.InfoWindow({
            content: `<div style="padding:5px;">
                        <strong>${store.name}</strong><br>
                        ${store.address}<br>
                        혼잡도: ${store.level}
                      </div>`
        });

        // 마커 클릭 이벤트
        kakao.maps.event.addListener(marker, "click", function() {
            info.open(map, marker);
        });
    });

    // 매장 리스트 UI도 같이 표시 (선택)
    renderStoreList(stores);
}

// 매장 리스트 UI
function renderStoreList(stores) {
    const listEl = document.getElementById("storeList");
    if (!listEl) return;

    listEl.innerHTML = stores.map(store => `
        <li>
            <strong>${store.name}</strong><br>
            ${store.address}<br>
            혼잡도: ${store.level}
        </li>
    `).join("");
}

// 지도 로드
kakao.maps.load(initMap);

    // 매장 리스트 렌더링 함수
    // function renderStoreList(list) {
    //     const container = document.getElementById("storeList");
    //     container.innerHTML = "";

    //     list.forEach((store) => {
    //         const isOpenNow = isOpen(store.hours);
    //         const statusText = isOpenNow ? "영업 중" : "영업 종료";
    //         const statusColor = isOpenNow ? "green" : "red";

    //         let crowdText = "";
    //         let crowdColor = "";
    //         let levelMsg = "";

    //         if (store.level === "여유") {
    //             crowdText = store.level;
    //             crowdColor = "green";
    //             levelMsg = "빈 자리 다수";
    //         } else if (store.level === "보통") {
    //             crowdText = store.level;
    //             crowdColor = "orange";
    //             levelMsg = "빈 자리 약간";
    //         } else {
    //             crowdText = store.level || "정보 없음";
    //             crowdColor = "red";
    //             levelMsg = "빈 자리 없음";
    //         }

    //         // 영업시간 텍스트
    //         let hoursText = "";
    //         if (store.storeHours && store.storeHours.length > 0) {
    //             store.storeHours.forEach(hour => {
    //                 const openClose = hour.isOpen ? `${hour.openTime} ~ ${hour.closeTime}` : "휴무";
    //                 hoursText += `${hour.dayOfWeek}: ${openClose}<br>`;
    //             });
    //         }

    //         // 매장 카드 HTML
    //         container.innerHTML += `
    //             <div class="store-card">
    //                 <div class="store-img" style="background-image:url('${store.imageUrl || './default.png'}'); background-size:cover; background-position:center;"></div>
    //                 <div class="store-info">
    //                     <div class="store-header">
    //                         <span class="store-name">${store.name}</span>
    //                         <button class="${store.alert ? "on" : "off"}"
    //                             onclick="toggleAlert(this, '${store.name}')">
    //                             <img src="${store.alert ? "./alert-icn-on.svg" : "./alert-icn.svg"}" style="width: clamp(20px, 6.5vw, 80px);">
    //                         </button>
    //                     </div>
    //                     <p class="store-meta-time" style="color:${statusColor}; font-weight:400;">
    //                         ${statusText} <br> ${hoursText}
    //                     </p>
    //                     <p class="store-meta-seat">
    //                         <span class="crowd-text" style="color:${crowdColor}; font-weight:400;">
    //                             ${crowdText}
    //                         </span>
    //                         <span style="margin-left:10px;">${levelMsg}</span>
    //                     </p>
    //                     <p>${store.address}</p>
    //                 </div>
    //             </div>
    //         `;
    //     });
    // }


    // 바텀시트
    const sheet = document.getElementById("bottomSheet");
    const dragBar = document.getElementById("dragBar");

    let startY = 0;
    let currentY = 0;
    let isDragging = false;
    let moved = false; // 드래그 여부 확인용
    let maxY = window.innerHeight * 0.6;

    function toggleSheet() {
        sheet.classList.toggle("open");
    }

    function dragStart(e) {
        startY = e.touches ? e.touches[0].clientY : e.clientY;
        isDragging = true;
        moved = false;
        sheet.style.transition = "none"; // 드래그 중에는 transition 제거
    }

    function dragMove(e) {
    if (!isDragging) return;
        e.preventDefault(); // 스크롤 방지

    let clientY = e.touches ? e.touches[0].clientY : e.clientY;
        currentY = clientY - startY;

    if (Math.abs(currentY) > 5) moved = true; // 5px 이상 움직이면 드래그로 간주

    let baseY = sheet.classList.contains("open") ? 0 : maxY;
    let moveY = baseY + currentY;

    if (moveY < 0) moveY = 0;
    if (moveY > window.innerHeight * 0.6) moveY = maxY;

    sheet.style.transform = `translateY(${moveY}px)`;
    }

    function dragEnd() {
        if (!isDragging) return;
        isDragging = false;
        sheet.style.transition = "transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1)";

        if (!moved) {
            // 움직임이 거의 없었다면 → 클릭으로 처리
            toggleSheet();
            return;
        }

        // 드래그였다면 스냅 동작
        if (currentY > maxY * 0.3) {
            sheet.classList.remove("open");
            sheet.style.transform = `translateY(${maxY}px)`;
        } else {
            sheet.classList.add("open");
            sheet.style.transform = `translateY(0)`;
        }
        currentY = 0;
    }

    // 이벤트 등록
    dragBar.addEventListener("mousedown", dragStart);
    document.addEventListener("mousemove", dragMove);
    document.addEventListener("mouseup", dragEnd);

    dragBar.addEventListener("touchstart", dragStart);
    document.addEventListener("touchmove", dragMove, { passive: false });
    document.addEventListener("touchend", dragEnd);

    window.addEventListener('resize', () => {
        maxY = window.innerHeight * 0.6;
    });

    function toggleSort(type){
        if(type==="crowd"){
            sortState.crowd = sortState.crowd==="desc"?"asc":"desc";
            document.getElementById("crowdArrow").src = sortState.crowd==="desc" ? "./arrow.svg":"./arrow-up.svg";
            const order = {혼잡:3, 보통:2, 여유:1};
            const sorted = [...stores].sort((a,b)=> sortState.crowd==="desc"? order[b.level]-order[a.level] : order[a.level]-order[b.level]);
            renderStoreList(sorted);
        } else {
            sortState.distance = sortState.distance==="asc"?"desc":"asc";
            document.getElementById("distanceArrow").src = sortState.distance==="asc" ? "./arrow.svg":"./arrow-up.svg";
            const sorted = [...stores].sort((a,b)=> sortState.distance==="asc"? a.distance-b.distance : b.distance-a.distance);
            renderStoreList(sorted);
        }
    }
    
    function toggleSearch(){
    const input = document.getElementById("searchInput");

    if(input.style.display === "none" || input.style.display === ""){
        input.style.display = "inline-block";
        input.style.width = "15vw"; // 너비 키우기
        input.focus();
    } else {
        input.style.display = "none";
        input.style.width = "8vw"; // 원래 너비로 복구
    }
    }

    function toggleAlert(btn, storeName){
        const store = stores.find(s => s.name === storeName);
        if(store){
            store.alert = !store.alert;
            btn.innerHTML = `<img src="${store.alert ? "./alert-icn-on.svg" : "./alert-icn.svg"}" style="width: clamp(20px, 6.5vw, 80px);">`;
            btn.classList.toggle("on", store.alert);
            btn.classList.toggle("off", !store.alert);
        }
    }

    const buttons = document.querySelectorAll(".filter-btn");

    buttons.forEach(btn => {
        btn.addEventListener("click", () => {
            // 모든 버튼 active 해제
            buttons.forEach(b => b.classList.remove("active"));

            // 클릭한 버튼에 active 추가
            btn.classList.add("active");

            // 화살표 토글 (오름/내림)
            const arrow = btn.querySelector(".arrow");
            if (arrow.classList.contains("up")) {
            arrow.classList.remove("up");
            arrow.classList.add("down");
            } else {
            arrow.classList.remove("down");
            arrow.classList.add("up");
            }
        });
    });



    </script>
</body>
</html>
